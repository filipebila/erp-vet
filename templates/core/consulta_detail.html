{% extends 'base.html' %}

{% block title %}Detalhes da Consulta{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-primary">Detalhes da Consulta</h2>
    <div class="card mt-3">
        <div class="card-body">
            <p><strong>Paciente:</strong> {{ consulta.paciente.nome }}</p>
            <p><strong>Tutor:</strong> {{ consulta.paciente.tutor.nome }}</p>
            <p><strong>Data e Hora:</strong> {{ consulta.data_hora|date:"d/m/Y H:i" }}</p>
            <p><strong>Motivo:</strong> {{ consulta.motivo }}</p>
            <p><strong>Anamnese:</strong> {{ consulta.anamnese }}</p>
            <p><strong>Exame F√≠sico:</strong> {{ consulta.exame_fisico }}</p>
            <p><strong>Diagn√≥stico:</strong> {{ consulta.diagnostico }}</p>
            <p><strong>Exames Solicitados:</strong> {{ consulta.exames_solicitados }}</p>
            <p><strong>Observa√ß√µes:</strong> {{ consulta.observacoes }}</p>
            <p><strong>Tratamento:</strong> {{ consulta.tratamento }}</p>
            <p><strong>Retorno Necess√°rio:</strong> {{ consulta.retorno_necessario|yesno:"Sim,N√£o" }}</p>
            {% if consulta.retorno_necessario and consulta.data_retorno %}
                <p><strong>Data do Retorno:</strong> {{ consulta.data_retorno|date:"d/m/Y H:i" }}</p>
            {% endif %}

            {% if consulta.arquivos.all %}
                <h5>Arquivos</h5>
                <ul>
                    {% for arquivo in consulta.arquivos.all %}
                    {% if arquivo.tipo == 'foto' %}
                        <li>
                        <a href="{{ arquivo.arquivo.url }}" target="_blank">
                            <img src="{{ arquivo.arquivo.url }}" alt="Foto" class="img-thumbnail mb-2" style="max-width: 200px;">
                        </a>
                        </li>
                    {% elif arquivo.tipo == 'video' %}
                        <li>
                        <a href="{{ arquivo.arquivo.url }}" target="_blank">üé• Ver v√≠deo</a>
                        </li>
                    {% endif %}
                    {% endfor %}
                </ul>
            {% endif %}
            {% if consulta.anamnese or consulta.diagnostico or consulta.tratamento %}
                <div class="mt-4">
                    {% if consulta.status_analise_ia == "concluida" and consulta.analise_ia %}
                        <div class="alert alert-info d-flex justify-content-between align-items-center">
                            <div>
                                ‚úÖ <strong>An√°lise da IA conclu√≠da</strong> ‚Äî Pronta para visualiza√ß√£o.
                            </div>
                            <a href="{% url 'analise_ia' consulta.id %}" class="btn btn-outline-success btn-sm">
                                <i class="bi bi-search"></i> Ver An√°lise
                            </a>
                        </div>
                    {% elif consulta.status_analise_ia == "em_analise" %}
                        <div class="alert alert-warning">‚è≥ A an√°lise da IA est√° em andamento...</div>
                    {% elif consulta.status_analise_ia == "erro" %}
                        <div class="alert alert-danger">‚ö†Ô∏è Houve um erro ao processar a an√°lise da IA.</div>
                    {% else %}
                        <form method="post" action="{% url 'gerar_analise_ia' consulta.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="bi bi-robot"></i> Analisar com IA
                            </button>
                        </form>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
    <div class="mt-3">
        {% if not consulta.anamnese and not consulta.diagnostico %}
          <a href="{% url 'consulta-atendimento' consulta.pk %}" class="btn btn-info">üìã Iniciar Atendimento</a>
        {% endif %}
        <a href="{% url 'consulta-atendimento' consulta.pk %}" class="btn btn-warning">Editar Consulta</a>
        <a href="{% url 'consultas-delete' consulta.pk %}" class="btn btn-danger ms-2">Excluir</a>
        <a href="{% url 'consultas-list' %}" class="btn btn-secondary ms-2">Voltar</a>
    </div>
</div>
{% endblock %}
